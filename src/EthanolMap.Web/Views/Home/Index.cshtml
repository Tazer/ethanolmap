@{
    ViewBag.Title = "Home Page";  
}
<h1>Ethanol Map5</h1>
<div id="ethanolMap"></div>
<div data-role="collapsible" id="instructions-container">
    <h3>Instructions</h3>
    <p><div id="instructions-content"></div></p>
</div>

@section scripts
{
    <script type="text/javascript">
        var EthanolMap = function(options) {
            var self = this;
            var map;
            var browserSupportFlag = new Boolean();
            var initialLocation;
            var targetDestination;
            var directionsDisplay = new google.maps.DirectionsRenderer();
            var directionsService = new google.maps.DirectionsService();
            var userMarker = null;
            var ethanolStationsMarkers = [];
            self.initMap = function() {
                var directionsDisplay = new google.maps.DirectionsRenderer();
                var mapOptions = {
                    center: new google.maps.LatLng(-34.397, 150.644),
                    zoom: 8,
                    mapTypeId: google.maps.MapTypeId.ROADMAP
                };
                map = new google.maps.Map(options.map, mapOptions);
                targetDestination = new google.maps.LatLng(57.15990, 12.31277);
                directionsDisplay.setMap(map);
                // Try W3C Geolocation (Preferred)
                if (navigator.geolocation) {
                    browserSupportFlag = true;
                    navigator.geolocation.getCurrentPosition(function(position) {
                        initialLocation = new google.maps.LatLng(position.coords.latitude, position.coords.longitude);
                        map.setCenter(initialLocation);
                    }, function() {
                        handleNoGeolocation(browserSupportFlag);
                    });
                }
                    // Browser doesn't support Geolocation
                else {
                    browserSupportFlag = false;
                    handleNoGeolocation(browserSupportFlag);
                }

                AddMarkersFromDatabase();
                UpdateRealtimeUserPosition();
            };

            function AddMarkersFromDatabase() {
                var newMarker = new google.maps.Marker({
                    position: new google.maps.LatLng(57.15990, 12.31277),
                    map: map,
                    animation: google.maps.Animation.DROP
                });

                google.maps.event.addListener(newMarker, 'click', function () {
                    targetDestination = newMarker;
                    if (userMarker && userMarker != '' && targetDestination && targetDestination != '') {
                        console.log("INSIDE");
                        var request = {
                            origin: userMarker.position,
                            destination: targetDestination.position,
                            travelMode: google.maps.DirectionsTravelMode["DRIVING"]
                        };

                        directionsService.route(request, function (response, status) {
                            console.log(response);
                            console.log(status);
                            if (status == google.maps.DirectionsStatus.OK) {
                                directionsDisplay.setPanel(document.getElementById("instructions-content"));
                                directionsDisplay.setDirections(response);

                                // For debuging reasons uncomment
                                /*
                                var myRoute = response.routes[0].legs[0];
                                for (var i = 0; i < myRoute.steps.length; i++) {
                                  alert(myRoute.steps[i].instructions);
                                }*/
                            }
                        });
                    }
                });

                ethanolStationsMarkers.push(newMarker);
            }

            function UpdateRealtimeUserPosition() {
                var options = {
                    maximumAge: 1000,
                    timeout: 5000,
                    enableHighAccuracy: true
                };
                var myUpdatedPos = navigator.geolocation.watchPosition(onSuccess, onError, options);

                function onSuccess(position) {

                    if (userMarker == null) {
                        userMarker = new google.maps.Marker({
                            position: new google.maps.LatLng(position.coords.latitude, position.coords.longitude),
                            map: map,
                            animation: google.maps.Animation.DROP
                        });
                    }

                    //here I update the position
                    var newLatlng = new google.maps.LatLng(position.coords.latitude, position.coords.longitude);
                    userMarker.setPosition(newLatlng);
                    map.setCenter(newLatlng);
                    directionsDisplay.setMap(map);

                }

                // onError Callback receives a PositionError object
                //

                function onError(error) {
                    alert('code: ' + error.code + '\n' +
                        'message: ' + error.message + '\n');
                }
            }


            function handleNoGeolocation(errorFlag) {
                if (errorFlag == true) {
                    alert("Geolocation service failed.");

                } else {
                    alert("Your browser doesn't support geolocation. We've placed you in Siberia.");
                }
                map.setCenter(initialLocation);
            }
        };

        $(document).ready(function() {
            var viewModel = new EthanolMap({ map: document.getElementById("ethanolMap") });
            viewModel.initMap();
        });

    </script>
}
